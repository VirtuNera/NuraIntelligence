{% extends "base.html" %}

{% block title %}Adaptive Quiz - {{ session_data.topic_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Session Progress Header -->
            <div class="card shadow mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h4 class="mb-1">
                                <i class="fas fa-brain me-2"></i>
                                {{ session_data.topic_name }}
                            </h4>
                            <p class="text-muted mb-0">Adaptive Quiz Session</p>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-md-end align-items-center">
                                <div class="me-4">
                                    <small class="text-muted">Set Progress:</small>
                                    <div class="progress" style="width: 150px; height: 8px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: {{ (session_data.current_set_number / session_data.total_sets) * 100 }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ session_data.current_set_number }} / {{ session_data.total_sets }}</small>
                                </div>
                                <div class="difficulty-badge">
                                    <span class="badge bg-{{ 'success' if session_data.current_difficulty == 'Very Easy' else 'info' if session_data.current_difficulty == 'Easy' else 'warning' if session_data.current_difficulty == 'Medium' else 'orange' if session_data.current_difficulty == 'Hard' else 'danger' }} px-3 py-2">
                                        {{ session_data.current_difficulty }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quiz Container -->
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="mb-0">
                                Question Set {{ set_data.set_number }} - {{ set_data.difficulty_level }}
                            </h5>
                        </div>
                        <div class="col-auto">
                            <div id="timer" class="timer-display">
                                <i class="fas fa-clock me-2"></i>
                                <span id="timer-text">{{ set_data.time_limit }}:00</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form id="adaptiveQuizForm" action="{{ url_for('submit_adaptive_set') }}" method="POST">
                        <input type="hidden" name="session_id" value="{{ session_data.session_id }}">
                        <input type="hidden" name="quiz_data" value="{{ set_data | tojson | e }}">
                        <input type="hidden" name="completion_time" id="completion_time" value="0">
                        
                        <!-- Progress Bar -->
                        <div class="mb-4">
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar" id="questionProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">Progress: <span id="progress-text">0 / {{ set_data.questions|length }}</span></small>
                                <small class="text-muted">Time: <span id="elapsed-time">0:00</span></small>
                            </div>
                        </div>

                        <!-- Questions Container -->
                        <div id="questionsContainer">
                            {% for question in set_data.questions %}
                            <div class="question-slide" id="question-{{ loop.index }}" {% if loop.index > 1 %}style="display: none;"{% endif %}>
                                <div class="question-card">
                                    <div class="question-header">
                                        <h6 class="text-muted mb-2">Question {{ loop.index }} of {{ set_data.questions|length }}</h6>
                                        <div class="question-info d-flex justify-content-between align-items-center mb-3">
                                            <span class="badge bg-light text-dark">{{ question.marks_worth }} marks</span>
                                            <span class="difficulty-indicator">{{ set_data.difficulty_level }}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="question-content">
                                        <h5 class="question-text mb-4">{{ question.description }}</h5>
                                        
                                        <div class="options-container">
                                            {% for option in question.options %}
                                            <div class="form-check option-card mb-3">
                                                <input class="form-check-input" type="radio" 
                                                       name="question_{{ question.question_id }}" 
                                                       id="q{{ loop.index0 }}_option{{ loop.index }}" 
                                                       value="{{ loop.index0 }}"
                                                       onchange="updateAnswer({{ loop.index0 }}, this)">
                                                <label class="form-check-label w-100" for="q{{ loop.index0 }}_option{{ loop.index }}">
                                                    <div class="option-content">
                                                        <span class="option-letter">{{ 'ABCD'[loop.index0] }}.</span>
                                                        <span class="option-text">{{ option }}</span>
                                                    </div>
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Navigation -->
                        <div class="quiz-navigation mt-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <button type="button" id="prevBtn" class="btn btn-outline-secondary" onclick="changeQuestion(-1)" disabled>
                                        <i class="fas fa-arrow-left me-2"></i>Previous
                                    </button>
                                </div>
                                <div class="col-md-6 text-end">
                                    <button type="button" id="nextBtn" class="btn btn-primary" onclick="changeQuestion(1)">
                                        Next<i class="fas fa-arrow-right ms-2"></i>
                                    </button>
                                    <button type="button" id="submitBtn" class="btn btn-success" onclick="submitSet()" style="display: none;">
                                        <i class="fas fa-check me-2"></i>Submit Set
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Question Navigation Pills -->
                        <div class="question-nav-pills mt-4">
                            <div class="d-flex flex-wrap gap-2 justify-content-center">
                                {% for question in set_data.questions %}
                                <button type="button" class="btn btn-outline-primary btn-sm question-pill" 
                                        onclick="goToQuestion({{ loop.index }})" 
                                        id="pill-{{ loop.index }}">
                                    {{ loop.index }}
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Submit Confirmation Modal -->
<div class="modal fade" id="submitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Submit Question Set</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you ready to submit this question set?</p>
                <div class="alert alert-info">
                    <strong>Summary:</strong>
                    <ul class="mb-0">
                        <li>Questions answered: <span id="answered-count">0</span> / {{ set_data.questions|length }}</li>
                        <li>Time elapsed: <span id="final-time">0:00</span></li>
                        <li>Current difficulty: {{ set_data.difficulty_level }}</li>
                    </ul>
                </div>
                <p class="text-muted">The next set's difficulty will be adjusted based on your performance.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continue Answering</button>
                <button type="button" class="btn btn-success" onclick="confirmSubmit()">
                    <i class="fas fa-check me-2"></i>Submit Set
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.timer-display {
    font-family: 'Courier New', monospace;
    font-size: 1.1em;
    font-weight: bold;
}

.question-slide {
    min-height: 400px;
}

.question-card {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
}

.option-card {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.option-card:hover {
    border-color: #007bff;
    background-color: #f8f9ff;
}

.option-card input:checked + label {
    color: #007bff;
    font-weight: 500;
}

.option-card:has(input:checked) {
    border-color: #007bff;
    background-color: #e7f3ff;
}

.option-content {
    display: flex;
    align-items: center;
}

.option-letter {
    font-weight: bold;
    margin-right: 10px;
    min-width: 25px;
}

.question-pill {
    width: 40px;
    height: 40px;
    border-radius: 50%;
}

.question-pill.answered {
    background-color: #28a745;
    border-color: #28a745;
    color: white;
}

.question-pill.current {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}

.difficulty-badge .bg-orange {
    background-color: #fd7e14 !important;
}
</style>

<script>
let currentQuestion = 1;
let totalQuestions = {{ set_data.questions|length }};
let startTime = new Date();
let timerInterval;
let timeLimit = {{ set_data.time_limit }};
let answers = {};

document.addEventListener('DOMContentLoaded', function() {
    startTimer();
    updateNavigation();
    updateProgress();
});

function startTimer() {
    let timeLeft = timeLimit;
    
    timerInterval = setInterval(function() {
        let minutes = Math.floor(timeLeft / 60);
        let seconds = timeLeft % 60;
        
        document.getElementById('timer-text').textContent = 
            minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
        
        // Update elapsed time
        let elapsed = Math.floor((new Date() - startTime) / 1000);
        let elapsedMinutes = Math.floor(elapsed / 60);
        let elapsedSeconds = elapsed % 60;
        document.getElementById('elapsed-time').textContent = 
            elapsedMinutes + ':' + (elapsedSeconds < 10 ? '0' : '') + elapsedSeconds;
        
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            autoSubmit();
        } else if (timeLeft <= 60) {
            document.getElementById('timer').style.color = '#dc3545';
        } else if (timeLeft <= 300) {
            document.getElementById('timer').style.color = '#ffc107';
        }
        
        timeLeft--;
    }, 1000);
}

function changeQuestion(direction) {
    let newQuestion = currentQuestion + direction;
    
    if (newQuestion >= 1 && newQuestion <= totalQuestions) {
        showQuestion(newQuestion);
    }
}

function showQuestion(questionNum) {
    // Hide current question
    document.getElementById('question-' + currentQuestion).style.display = 'none';
    
    // Show new question
    document.getElementById('question-' + questionNum).style.display = 'block';
    
    // Update current question
    currentQuestion = questionNum;
    
    updateNavigation();
    updateProgress();
    updateQuestionPills();
}

function goToQuestion(questionNum) {
    showQuestion(questionNum);
}

function updateAnswer(questionNum, input) {
    answers['question_' + questionNum] = input.value;
    updateQuestionPills();
    updateProgress();
}

function updateNavigation() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    
    prevBtn.disabled = currentQuestion === 1;
    
    if (currentQuestion === totalQuestions) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'inline-block';
    } else {
        nextBtn.style.display = 'inline-block';
        submitBtn.style.display = 'none';
    }
}

function updateProgress() {
    let answeredCount = Object.keys(answers).length;
    let progressPercent = (currentQuestion / totalQuestions) * 100;
    
    document.getElementById('questionProgress').style.width = progressPercent + '%';
    document.getElementById('progress-text').textContent = currentQuestion + ' / ' + totalQuestions;
}

function updateQuestionPills() {
    for (let i = 1; i <= totalQuestions; i++) {
        const pill = document.getElementById('pill-' + i);
        pill.className = 'btn btn-outline-primary btn-sm question-pill';
        
        if (i === currentQuestion) {
            pill.classList.add('current');
        } else if (answers['question_' + i]) {
            pill.classList.add('answered');
        }
    }
}

function submitSet() {
    // Update modal with current stats
    document.getElementById('answered-count').textContent = Object.keys(answers).length;
    
    let elapsed = Math.floor((new Date() - startTime) / 1000);
    let minutes = Math.floor(elapsed / 60);
    let seconds = elapsed % 60;
    document.getElementById('final-time').textContent = 
        minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
    
    // Show confirmation modal
    new bootstrap.Modal(document.getElementById('submitModal')).show();
}

function confirmSubmit() {
    // Set completion time
    let completionTime = Math.floor((new Date() - startTime) / 1000);
    document.getElementById('completion_time').value = completionTime;
    
    // Clear timer
    clearInterval(timerInterval);
    
    // Submit form
    document.getElementById('adaptiveQuizForm').submit();
}

function autoSubmit() {
    // Auto-submit when time runs out
    let completionTime = Math.floor((new Date() - startTime) / 1000);
    document.getElementById('completion_time').value = completionTime;
    document.getElementById('adaptiveQuizForm').submit();
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft' && currentQuestion > 1) {
        changeQuestion(-1);
    } else if (e.key === 'ArrowRight' && currentQuestion < totalQuestions) {
        changeQuestion(1);
    } else if (e.key === 'Enter' && currentQuestion === totalQuestions) {
        submitSet();
    }
});
</script>
{% endblock %}